#!/bin/sh

print_usage() {
	echo 'Usage:'
	echo '  git install-hooks [--status]'
	echo '  git install-hooks --help'
	echo '  git install-hooks <git-project> [<other project> ...]'
	echo '  git install-hooks --init'
	exit 1
}

script_location=$(dirname "$0")

is_init=false
is_status=false
is_help=false

for var in "$@"
do
	if [ "$var" == "--init" ]; then
		is_init=true
	fi
	if [ "$var" == "--status" ]; then
		is_status=true
	fi
	if [ "$var" == "--help" ]; then
		is_help=true
	fi
done

if [ "$1" == "" ]; then
	is_status=true
fi

if [ $is_help == "true" ]; then
	print_usage
fi

hooks_path="$script_location"/git-templates/hooks

if [ $is_status == "true" ]; then
	current_global=$(git config --global core.hooksPath)
	if [ "$current_global" == "$hooks_path" ]; then
		echo "Global hook installed."
	else
		echo "Global hook is not installed."
	fi

	current_local=$(git config core.hooksPath)
	if [ "$current_local" != "$current_global" ]; then
		echo "Local hooksPath has overridden global hook."
		echo "Local hooksPath: $current_local"
	fi

	echo

	additional_hooks=$(git config --get-all fizker.hooksPath)
	if [ "$additional_hooks" == "" ]; then
		echo "No additional hooks"
	else
		echo "Additional hooks:"
		node -e "
			console.log(process.argv[1].split(/\n/g).map(x => '- ' + x).join('\n'))
		" "$additional_hooks"
	fi
	exit 0
fi

if [ $is_init == "true" ]; then
	git config --global core.hooksPath "$hooks_path"

	exit 0
fi

for target_repo in "$@"
do
	pushd "$target_repo" &> /dev/null

	existing_hooks_path=$(git config core.hooksPath)
	if [ "$existing_hooks_path" != "" ] && [ "$existing_hooks_path" != "$hooks_path" ];
	then
		set +e
		_=$(git config --get fizker.hooksPath "^$existing_hooks_path$")
		has_registered_hook=$?
		set -e

		if [ $has_registered_hook != 0 ]; then
			git config --add fizker.hooksPath "$existing_hooks_path"
		fi
		git config --unset core.hooksPath
	fi

	popd &> /dev/null
done
